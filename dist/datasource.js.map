{"version":3,"sources":["../src/datasource.js"],"names":["_","GenericDatasource","instanceSettings","$q","backendSrv","templateSrv","type","url","name","q","options","query","buildQueryParameters","targets","filter","t","hide","length","when","data","console","log","datasourceRequest","encodeURIComponent","expr","method","headers","then","results","i","response","item","rows","push","Date","parse","startsAt","formatInstanceText","labels","alertname","parseInt","severity","now","status","message","title","target","map","replace","refId","text","certname","rancher_host","instance","rancher_environment"],"mappings":"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","file":"datasource.js","sourcesContent":["import _ from \"lodash\";\n\nexport class GenericDatasource {\n\n  constructor(instanceSettings, $q, backendSrv, templateSrv) {\n    this.type = instanceSettings.type;\n    this.url = instanceSettings.url;\n    this.name = instanceSettings.name;\n    this.q = $q;\n    this.backendSrv = backendSrv;\n    this.templateSrv = templateSrv;\n  }\n\n  query(options) {\n    var query = this.buildQueryParameters(options);\n    query.targets = query.targets.filter(t => !t.hide);\n    \n\n    if (query.targets.length <= 0) {\n      return this.q.when({data: []});\n    }\n    console.log(this);\n    // Format data for table panel\n    if(query.targets[0].type == \"table\"){\n      return this.backendSrv.datasourceRequest({\n        url: this.url + '/api/v1/alerts?filter='+encodeURIComponent(query.targets[0].expr || \"\"),\n        data: query,\n        method: 'GET',\n        headers: { 'Content-Type': 'application/json' }\n      }).then(response => {\n        var results = {\n          \"data\": [\n            {\n              \"columns\":[\n                {\"text\": \"Time\", \"type\": \"time\"},\n                {\"text\": \"Instance\", \"type\": \"string\"},\n                {\"text\": \"Alertname\", \"type\": \"string\"},\n                {\"text\": \"Severity\", \"type\": \"Number\"}\n              ],\n              \"rows\": [],\n              \"type\": \"table\"\n            }\n          ]\n        };\n        for(var i=0;i<response.data.data.length;i++){\n          var item = response.data.data[i];\n          results.data[0].rows.push([\n            Date.parse(item.startsAt),\n            this.formatInstanceText(item.labels),\n            item.labels.alertname,\n            parseInt(item.labels.severity)\n          ]);\n        };\n        return results;\n      });\n    }else{\n      return this.backendSrv.datasourceRequest({\n        url: this.url + '/api/v1/alerts?filter='+encodeURIComponent(query.targets[0].expr || \"\"),\n        data: query,\n        method: 'GET',\n        headers: { 'Content-Type': 'application/json' }\n      }).then(response => {\n        return {\n          \"data\": [\n            {\n              \"datapoints\": [\n                [response.data.data.length, Date.now()]\n              ]\n            }\n          ]\n        }\n      });\n    }\n  }\n\n  testDatasource() {\n    return this.backendSrv.datasourceRequest({\n      url: this.url + '/api/v1/status',\n      method: 'GET'\n    }).then(response => {\n      if (response.status === 200) {\n        return { status: \"success\", message: \"Data source is working\", title: \"Success\" };\n      }\n    });\n  }\n\n  buildQueryParameters(options) {\n    //remove placeholder targets\n      options.targets = _.filter(options.targets, target => {\n      return target.target !== 'select metric';\n    });\n    var targets = _.map(options.targets, target => {\n      return {\n        target: this.templateSrv.replace(target.target),\n        expr: target.expr,\n        refId: target.refId,\n        hide: target.hide,\n        type: target.type || 'timeserie'\n      };\n    });\n    options.targets = targets;\n    return options;\n  }\n\n  formatInstanceText(labels, url){\n    var text = \"\";\n    if(typeof labels.certname != 'undefined'){\n      text += labels.certname;\n    }else if(typeof labels.rancher_host != 'undefined'){\n      text += labels.rancher_host;\n    }\n    if(typeof labels.instance != 'undefined'){\n      text += \"[\"+labels.instance+\"]\";\n    }\n    if(typeof labels.rancher_environment != 'undefined'){\n      text += \" (\"+labels.rancher_environment+\")\";\n    }\n    return text;\n  }\n  \n}\n"]}